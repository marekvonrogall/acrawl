<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CME Viewer</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body class="cme-body">
    <div class="nav-links" id="navLinks"></div>
    <h1 id="currentPair">Loading...</h1>

    <div class="controls" id="controls">
      <label>
        Time per image (ms):
        <input type="number" id="timeInput" value="100" min="10" step="10" />
      </label>
    </div>

    <div class="image-container">
      <img id="img1" src="" alt="Image 1" />
      <img id="img2" src="" alt="Image 2" />
    </div>

    <div id="currentUrl" style="margin-top: 10px">
      <a id="urlLink" href="#" target="_blank" style="color: #636B2F"></a>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const cme_date = params.get("cme_date") || "";
      const fetching_date = params.get("fetching_date") || "";

      // Navigation links
      const pages = [
        { name: "cme", file: "cme.html", useCmeDate: true },
        { name: "plots", file: "plots.html", useCmeDate: false },
        { name: "sun images", file: "sun_images.html", useCmeDate: false },
        { name: "sun videos", file: "sun_videos.html", useCmeDate: false },
      ];

      const navDiv = document.getElementById("navLinks");
      pages.forEach((p) => {
        const link = document.createElement("a");
        link.href = `${p.file}?cme_date=${cme_date}&fetching_date=${fetching_date}`;
        link.textContent = p.name;
        navDiv.appendChild(link);
      });

      // CME Viewer logic
      let base_dir = "./../data/";
      if (cme_date) base_dir += `${cme_date}/`;

      let data = [];
      let currentSet = 0;
      let currentIndex = 0;
      let intervalId = null;
      let timePerImage = 100;

      async function loadData() {
        try {
          const response = await fetch(`${base_dir}matches.json`);
          const rawData = await response.json();

          data = rawData
            .map((entry) => {
              entry.skip = Object.keys(entry).includes("wwaves");
              return entry;
            })
            .filter((entry) => !entry.skip);

          if (data.length > 0) {
            createSequenceButtons();
            startAnimation();
          } else {
            document.getElementById("currentPair").innerText =
              "No images to display";
          }
        } catch (err) {
          console.error("Failed to load JSON:", err);
          document.getElementById("currentPair").innerText =
            "Failed to load JSON";
        }
      }

      function updateImages() {
        if (!data.length) return;
        const set = data[currentSet];
        const keys = Object.keys(set).filter((k) => Array.isArray(set[k]));
        const img1List = set[keys[0]];
        const img2List = set[keys[1]];

        document.getElementById(
          "currentPair"
        ).innerText = `${keys[0]} - ${keys[1]}`;

        const img1Path = `${base_dir}${set.path[0]}/${img1List[currentIndex]}`;
        const img2Path = `${base_dir}${set.path[1]}/${img2List[currentIndex]}`;

        document.getElementById("img1").src = img1Path;
        document.getElementById("img2").src = img2Path;

        const urlLink = document.getElementById("urlLink");
        urlLink.href = set.url;
        urlLink.textContent = set.url;

        currentIndex++;
        if (currentIndex >= img1List.length) currentIndex = 0;
      }

      function startAnimation() {
        if (intervalId) clearInterval(intervalId);
        intervalId = setInterval(updateImages, timePerImage);
      }

      function createSequenceButtons() {
        const controlsDiv = document.getElementById("controls");
        data.forEach((entry, index) => {
          const keys = Object.keys(entry).filter((k) =>
            Array.isArray(entry[k])
          );
          const button = document.createElement("button");
          button.textContent = `${keys[0]} - ${keys[1]}`;
          button.onclick = () => {
            currentSet = index;
            currentIndex = 0;
            startAnimation();
          };
          controlsDiv.appendChild(button);
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        const timeInput = document.getElementById("timeInput");
        function loadTimeInput() {
          const val = parseInt(timeInput.value);
          if (!isNaN(val) && val > 0) {
            timePerImage = val;
            startAnimation();
          }
        }

        loadData();
        loadTimeInput();
        timeInput.addEventListener("change", loadTimeInput);
      });
    </script>
  </body>
</html>
